<!DOCTYPE html>
<html>

<head>
    <script src="bower_components/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        var configureLog = function () {
            try {
                var url = new URL(document.referrer);
                var urlParams = new URLSearchParams(url.search.substring(1));
                debug = urlParams.has("debug");
                info = urlParams.has("info");
            }
            catch (exception) {
                console.log("unable to configure Log");
            }
        }

        var logDebug = function (message) {
            if (debug === true) {
                console.log("[DEBUG] " + "(" + new Date().toLocaleTimeString() + ") ", message);
            }
        }

        var logInfo = function (message) {
            if (info === true) {
                console.log("[INFO] " + "(" + new Date().toLocaleTimeString() + ") ", message);
            }
        }

        //Init
        var debug = false;
        var info = false;
        configureLog();
        var settings;

        VSS.require(["TFS/Dashboards/WidgetHelpers", "TFS/WorkItemTracking/RestClient"], function (WidgetHelpers, RestClient) {
            logDebug("VSS.require()");

            WidgetHelpers.IncludeWidgetStyles();

            //Gets current project ID
            var projectId = VSS.getWebContext().project.id;
            logInfo("VSS.getWebContext():");
            logInfo(VSS.getWebContext());

            VSS.register("querytile-extended-widget", function () {
                logDebug("VSS.register()");

                var getQueryInfo = function () {
                    logDebug("getQueryInfo()");

                    if (!settings || !settings.queryId || !settings.fieldName || !settings.aggregationType || !settings.unit || !settings.backgroundColor || !settings.color) {
                        var $workitems = $("#workitems");
                        $workitems.text("Sorry nothing to show, please configure the widget");

                        return WidgetHelpers.WidgetStatusHelper.Success();
                    }

                    //Get query by configured id
                    return RestClient.getClient().queryById(settings.queryId, projectId)
                        .then(function (queryByIdResult) {
                            logInfo("RestClient.getClient().queryById(" + settings.queryId + ", " + projectId + "):");
                            logInfo(queryByIdResult);

                            var $queryLink = $("#query-link");
                            $queryLink.prop("href", VSS.getWebContext().collection.uri + VSS.getWebContext().project.name + "/_workItems/resultsById/" + settings.queryId);

                            var $workitems = $("#workitems");
                            $workitems.text(queryByIdResult.workItems.length + " WI");

                            //TODO : Si aucun élément, on renvoie directement
                            if (queryByIdResult.workItems.length === 0) {
                                var $count = $('div.big-count');
                                $count.text("-");

                                // Use the widget helper and return success as Widget Status
                                return WidgetHelpers.WidgetStatusHelper.Success();
                            }

                            var workItemIds = [];
                            queryByIdResult.workItems.forEach(workItem => {
                                workItemIds.push(workItem.id);
                            });

                            var fields = [];
                            fields.push(settings.fieldName);

                            //Get workitems from id list
                            return RestClient.getClient().getWorkItems(workItemIds, fields)
                                .then(function (getWorkItemsResult) {
                                    logInfo("RestClient.getClient().getWorkItems(" + workItemIds + ", " + fields + "):");
                                    logInfo(getWorkItemsResult);

                                    logInfo("settings.fieldName: " + settings.fieldName);

                                    const sum = (previous, current) => {
                                        if (!current.fields[settings.fieldName]) {
                                            return previous;
                                        }
                                        var currentValue = current.fields[settings.fieldName];
                                        return previous + currentValue;
                                    }
                                    const highest = (previous, current) => {
                                        if (!current.fields[settings.fieldName]) {
                                            return previous;
                                        }
                                        var currentValue = current.fields[settings.fieldName];
                                        return previous > currentValue ? previous : currentValue;
                                    }
                                    const lowest = (previous, current) => {
                                        if (!current.fields[settings.fieldName]) {
                                            return previous;
                                        }
                                        var currentValue = current.fields[settings.fieldName];
                                        return previous > -currentValue ? previous : -currentValue;
                                    }
                                    const countempty = (previous, current) => {
                                        if (current.fields[settings.fieldName]) {
                                            return previous;
                                        }
                                        return previous + 1;
                                    }
                                    const countnotempty = (previous, current) => {
                                        if (!current.fields[settings.fieldName]) {
                                            return previous;
                                        }
                                        return previous + 1;
                                    }

                                    var aggregation = 0;

                                    switch (settings.aggregationType) {
                                        case "sum":
                                            aggregation = getWorkItemsResult.reduce(sum, 0);
                                            logInfo("sum:");
                                            logInfo(aggregation);
                                            break;
                                        case "highest":
                                            aggregation = getWorkItemsResult.reduce(highest, 0);
                                            logInfo("highest:");
                                            logInfo(aggregation);
                                            break;
                                        case "lowest":
                                            aggregation = -getWorkItemsResult.reduce(lowest, 0);
                                            logInfo("lowest:");
                                            logInfo(aggregation);
                                            break;
                                        case "average":
                                            aggregation = getWorkItemsResult.reduce(sum, 0) / getWorkItemsResult.length;
                                            logInfo("average:");
                                            logInfo(aggregation);
                                            break;
                                        case "countempty":
                                            aggregation = getWorkItemsResult.reduce(countempty, 0);
                                            logInfo("countempty:");
                                            logInfo(aggregation);
                                            break;
                                        case "countnotempty":
                                            aggregation = getWorkItemsResult.reduce(countnotempty, 0);
                                            logInfo("countnotempty:");
                                            logInfo(aggregation);
                                            break;
                                    }

                                    if (settings.multiplicationFactor) {
                                        aggregation = aggregation * settings.multiplicationFactor;
                                    }

                                    if (settings.divisionFactor) {
                                        aggregation = aggregation / settings.divisionFactor;
                                    }

                                    if (settings.rounding) {
                                        switch (settings.rounding) {
                                            case "0":
                                                aggregation = Math.round(aggregation);
                                                break;
                                            case "1":
                                                aggregation = Math.round(aggregation * 10) / 10;
                                                break;
                                            case "2":
                                                aggregation = Math.round(aggregation * 100) / 100;
                                                break;
                                        }
                                    }

                                    var $count = $('div.big-count');
                                    $count.text(aggregation);

                                    // Use the widget helper and return success as Widget Status
                                    return WidgetHelpers.WidgetStatusHelper.Success();
                                });
                        }, function (error) {
                            // Use the widget helper and return failure as Widget Status
                            return WidgetHelpers.WidgetStatusHelper.Failure(error.message);
                        });
                }

                var applySettings = function (widgetSettings) {
                    logInfo("applySettings():");
                    logInfo(widgetSettings);

                    settings = JSON.parse(widgetSettings.customSettings.data);

                    // Set your title
                    var $title = $('h2.title');
                    $title.text(widgetSettings.name);

                    var $unit = $('#unit');
                    $unit.text(settings.unit);

                    var $widget = $("#widget");
                    $widget.css("background-color", settings.backgroundColor);
                    $widget.addClass(settings.aggregationType);

                    var $queryLink = $("#query-link");
                    $queryLink.css("color", settings.color);

                    return getQueryInfo();
                }

                return {
                    load: function (widgetSettings) {
                        logDebug("onLoad()");

                        return applySettings(widgetSettings);
                    },
                    reload: function (widgetSettings) {
                        logDebug("onReload()");

                        return applySettings(widgetSettings);
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
    <style>
        .sum {
            background-image: url("images/sum.png"), url("rounded-square.png");
            background-repeat: no-repeat;
            background-position: top 6px right 6px;
            background-size: 14px;
        }

        .highest {
            background-image: url("images/highest.png"), url("rounded-square.png");
            background-repeat: no-repeat;
            background-position: top 6px right 6px;
            background-size: 14px;
        }

        .lowest {
            background-image: url("images/lowest.png"), url("rounded-square.png");
            background-repeat: no-repeat;
            background-position: top 6px right 6px;
            background-size: 14px;
        }

        .average {
            background-image: url("images/average.png"), url("rounded-square.png");
            background-repeat: no-repeat;
            background-position: top 6px right 6px;
            background-size: 14px;
        }

        .countempty {
            background-image: url("images/countempty.png"), url("rounded-square.png");
            background-repeat: no-repeat;
            background-position: top 6px right 6px;
            background-size: 14px;
        }

        .countnotempty {
            background-image: url("images/countnotempty.png"), url("rounded-square.png");
            background-repeat: no-repeat;
            background-position: top 6px right 6px;
            background-size: 14px;
        }

        div.flex_container {
            display: flex;
            justify-content: space-between;
        }

        div.flex-child-growable {
            flex: 1;
        }

        #unit {
            text-align: left;
        }

        #workitems {
            text-align: right;
        }
    </style>
</head>

<body>
    <div id="widget" class="widget clickable" style="background-color: rgb(255, 255, 255); color: rgb(0, 0, 0);">
        <a id="query-link" href="" target="_parent">
            <div>
                <h2 class="title truncated-text-ellipsis">Counter widget</h2>
                <div class="big-count truncated-text-ellipsis">223</div>
                <div class="footer flex_container truncated-text-ellipsis">
                    <div id="unit" class="truncated-text-ellipsis"></div>
                    <div id="workitems" class="flex-child-growable truncated-text-ellipsis"></div>
                </div>
            </div>
        </a>
    </div>
</body>

</html>